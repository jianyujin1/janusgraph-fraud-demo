
# JanusGraph + LLM ê¸°ë°˜ Fraud Detection: Graph êµ¬ì¶• ë° LLM ìš”ì•½ (2ì£¼ì°¨)

## í”„ë¡œì íŠ¸ ê°œìš”

- **ì§€ë‚œì£¼**: JanusGraphë¥¼ í™œìš©í•´ ê°„ë‹¨í•œ ê·¸ë˜í”„ êµ¬ì¡°ë¥¼ êµ¬ì„±í•˜ê³ , fraud detection í”„ë¡œì íŠ¸ ì´ˆì„ ë§ˆë ¨
- **ì´ë²ˆì£¼**: ì‹¤ì œ ê¸ˆìœµ ì‚¬ê¸° ë°ì´í„°ì…‹(`creditcard.csv`)ì„ í™œìš©í•´
  - ê±°ë˜(Transaction) ê°„ ìœ ì‚¬ì„±ì„ ê¸°ë°˜ìœ¼ë¡œ ê·¸ë˜í”„ ìƒì„±
  - LLM ê¸°ë°˜ ê±°ë˜ ìš”ì•½ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•
  - Fraud ì—¬ë¶€ë¥¼ LLM ê²°ê³¼ì— ëª…í™•íˆ ë°˜ì˜í•˜ëŠ” í”„ë¡¬í”„íŠ¸ ê°œì„ 
  - (CPU/GPU ë•Œë¬¸ì— localì—ì„œ ì¢€ ë” ë¹ ë¦¿í•œ colabì—ì„œ ì‚¬ìš©í•¨)
  - (OpenAI ìœ ë£Œì´ë¯€ë¡œ ì˜¤í”ˆì†ŒìŠ¤ huggingfaceì‚¬ìš©) 
## í™˜ê²½ êµ¬ì¶• ë° ì„¤ì¹˜

\```python  
!pip install pandas
!pip install networkx
!pip install langchain langchain-huggingface transformers
!pip install huggingface_hub[hf_xet]
!pip install sentence-transformers
\```

## ë°ì´í„° ì¤€ë¹„ (Kaggle)

\```python
import pandas as pd
df = pd.read_csv('creditcard.csv')
print(df.head())
\```

## ê·¸ë˜í”„ ìƒì„± (NetworkX)

\```python
import networkx as nx
G = nx.Graph()

for idx, row in df.iterrows():
    G.add_node(idx, amount=row['Amount'], time=row['Time'], label=row['Class'])

for i in range(len(df)):
    for j in range(i+1, min(i+100, len(df))):
        if abs(df.loc[i, 'Amount'] - df.loc[j, 'Amount']) < 1.0 and abs(df.loc[i, 'Time'] - df.loc[j, 'Time']) < 10:
            G.add_edge(i, j)

print(f"ë…¸ë“œ ìˆ˜: {G.number_of_nodes()}ê°œ, ì—£ì§€ ìˆ˜: {G.number_of_edges()}ê°œ")
\```

## LLM ìš”ì•½ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

\```python
from transformers import pipeline
from langchain.prompts import PromptTemplate
from langchain_huggingface import HuggingFacePipeline
from langchain_core.runnables import RunnableSequence

summarizer_pipeline = pipeline(
    "summarization",
    model="google/flan-t5-small", # ê°€ë²¼ìš´ LLM ì‚¬ìš©
    tokenizer="google/flan-t5-small",
    device=-1,
    max_length=30,
    min_length=10
)

llm = HuggingFacePipeline(pipeline=summarizer_pipeline)

prompt = PromptTemplate(
    input_variables=["fraud_description"],
    template="Summarize the following credit card transaction situation:\n{fraud_description}"
)

fraud_summary_chain = prompt | llm
\```

## ê±°ë˜ ì„¤ëª… ìƒì„± ë° ìš”ì•½

\```python
node_id = 0
node_data = G.nodes[node_id]

desc = f"Transaction of ${node_data['amount']} at time {node_data['time']} seconds. Label: {'Fraud' if node_data['label']==1 else 'Normal'}."
input_data = {"fraud_description": desc}
result = fraud_summary_chain.invoke(input_data)

print(result)
\```

## í”„ë¡¬í”„íŠ¸ ê°œì„  (Fraud ì—¬ë¶€ ëª…ì‹œ)

\```python
prompt = PromptTemplate(
    input_variables=["fraud_description"],
    template='''
    Summarize the following credit card transaction situation.
    If it is a fraud transaction, clearly mention it is FRAUD.
    If it is a normal transaction, summarize normally.

    Transaction Description:
    {fraud_description}
    '''
)

fraud_summary_chain = prompt | llm
\```

## 100ê±´ ê±°ë˜ ì¼ê´„ ìš”ì•½

\```python
summarized_texts = []

for node_id in list(G.nodes)[:100]:
    node_data = G.nodes[node_id]
    desc = f"Transaction of ${node_data['amount']} at time {node_data['time']} seconds. Label: {'Fraud' if node_data['label']==1 else 'Normal'}."
    input_data = {"fraud_description": desc}
    
    try:
        result = fraud_summary_chain.invoke(input_data)
        summarized_texts.append(result)
    except Exception as e:
        summarized_texts.append("Error")

df_summary = df.iloc[:100].copy()
df_summary['summary'] = summarized_texts

import pandas as pd
pd.set_option('display.max_colwidth', None)
df_summary.index = [f"Transaction {i}" for i in df_summary.index]
df_summary[['summary']]
\```

---

## ì •ë¦¬

'''
# ğŸ“ˆ 1. Graph Creation (NetworkX)

- `import networkx as nx`: Import NetworkX library for graph creation.
- `G = nx.Graph()`: Create an empty graph G.

- `for idx, row in df.iterrows():`: Loop over each transaction (row) in the dataset.
- `G.add_node(...)`: Add a node to G, with attributes: amount, time, and fraud label.

- `for i in range(len(df)):`: Loop over each transaction i.
- `for j in range(i+1, min(i+100, len(df))):`: For each i, look at the next 100 transactions only (for speed).
- `if abs(Amount difference) < 1.0 and abs(Time difference) < 10:`: If amounts and times are close enough, connect them.
- `G.add_edge(i, j)`: Add an edge between similar transactions.

---

# ğŸ¤– 2. Summarization LLM Pipeline (HuggingFace)

- `from transformers import pipeline`: Import HuggingFace pipeline.

- `pipeline("summarization", model, tokenizer, device, max_length, min_length)`: 
  Load a small lightweight LLM (Flan-T5-small) for summarization.
  - `device=-1`: Use CPU.
  - `max_length=30`, `min_length=10`: Control summary size.

---

# ğŸ”— 3. Connect LLM with LangChain

- `from langchain_huggingface import HuggingFacePipeline`: Wrap the HuggingFace model.
- `from langchain.prompts import PromptTemplate`: Create templates for LLM prompts.
- `from langchain_core.runnables import RunnableSequence`: Chain together prompt â†’ model.

- `llm = HuggingFacePipeline(pipeline=summarizer_pipeline)`: Wrap the summarizer.

- `prompt = PromptTemplate(input_variables=["fraud_description"], template="...")`: 
  Create a prompt asking LLM to summarize a fraud description.

- `fraud_summary_chain = prompt | llm`: 
  Link the prompt and model together into one runnable chain.

---

# âœï¸ 4. Summarize a Single Transaction

- `node_id = 0`: Pick the first transaction.
- `node_data = G.nodes[node_id]`: Get transaction data.
- Create description text manually with amount, time, and fraud/normal label.

- `input_data = {"fraud_description": desc}`: Prepare input for chain.

- `result = fraud_summary_chain.invoke(input_data)`: Run summarization chain.
- `print(result)`: See summarized result.

---

# ğŸ› ï¸ 5. Improve the Prompt (Highlight Fraud)

- Create a better prompt:
  - If the transaction is Fraud â†’ clearly say "FRAUD" in the summary.
  - If normal â†’ just summarize normally.

- `fraud_summary_chain = prompt | llm`: Update chain to use the new prompt.

---

# ğŸ” 6. Summarize 100 Transactions

- `summarized_texts = []`: Prepare a list to collect results.

- For the first 100 transactions:
  - Create description text.
  - Summarize using LLM.
  - Save summarized text into list.
  - If any error happens, save "Error" instead.

---

# ğŸ“‘ 7. Save and Display Summarized Results

- `df_summary = df.iloc[:100].copy()`: Copy first 100 rows.
- `df_summary['summary'] = summarized_texts`: Add summarized results as a new column.

- `pd.set_option('display.max_colwidth', None)`: Make sure full summaries are displayed.
- `df_summary.index = [f"Transaction {i}" for i in df_summary.index]`: Rename index for clarity.
- `df_summary[['summary']]`: Display the final summarized table.

---
'''


